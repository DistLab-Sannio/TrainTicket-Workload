# Train Ticket LoadTester

This project provides all the necessary resources, including configuration files, scripts, and documentation,
to set up and execute a comprehensive load test on the Train Ticket microservices benchmark.
The benchmark simulates a realistic train ticketing system, allowing for the evaluation of performance, scalability,
and resilience of microservices-based system under varying loads. The benchmark can be accessed via the following
[link](https://github.com/FudanSELab/train-ticket).
Additional information on installation, setup, and usage instructions are also available
[wiki](https://github.com/FudanSELab/train-ticket/wiki).

## API

The workload for the microservices-based application was generated by targeting external 
client-accessible endpoints that could be queried via the web Dashboard (`index.html`). 
The table summarizes these endpoints, listing their URLs, HTTP methods, 
unique identifiers, and the corresponding microservices.

| ID     | Microservice   | Method | Endpoint                                     |
|--------|----------------|--------|----------------------------------------------|
| $ab_1$ | admin-basic    | GET    | /adminbasicservice/adminbasic/contacts       |
| $ab_2$ | admin-basic    | GET    | /adminbasicservice/adminbasic/prices         |
| $ab_3$ | admin-basic    | PUT    | /adminbasicservice/adminbasic/contacts       |
| $ab_4$ | admin-basic    | PUT    | /adminbasicservice/adminbasic/prices         |
| $ao_1$ | admin-order    | POST   | /adminorderservice/adminorder                |
| $ao_2$ | admin-order    | GET    | /adminorderservice/adminorder                |
| $ao_3$ | admin-order    | PUT    | /adminorderservice/adminorder                |
| $ar_1$ | admin-route    | GET    | /adminrouteservice/adminroute                |
| $at_1$ | admin-travel   | POST   | /admintravelservice/admintravel              |
| $at_2$ | admin-travel   | GET    | /admintravelservice/admintravel              |
| $at_3$ | admin-travel   | PUT    | /admintravelservice/admintravel              |
| $au_1$ | admin-user     | POST   | /adminuserservice/users                      |
| $au_2$ | admin-user     | GET    | /adminuserservice/users                      |
| $as_1$ | assurance      | GET    | /assuranceservice/assurances/types           |
| $ca_1$ | cancel         | GET    | /cancelservice/cancel/{orderId}/{userId}     |
| $ca_2$ | cancel         | GET    | /cancelservice/cancel/refound/{orderId}      |
| $co_1$ | contacts       | GET    | /contactservice/contacts/account/{userId}    |
| $da_1$ | dashboard      | GET    | /admin.html                                  |
| $da_2$ | dashboard      | GET    | /client_login.html                           |
| $da_3$ | dashboard      | GET    | /index.html                                  |
| $ex_1$ | execute        | GET    | /executeservice/execute/collected/{orderId}  |
| $ex_2$ | execute        | GET    | /executeservice/execute/execute/{orderId}    |
| $fo_1$ | food           | GET    | /foodservice/foods/{date}/{s1}/{s2}/{tripId} |
| $ip_1$ | inside-payment | POST   | /inside_pay_service/inside_payment           |
| $oh_1$ | order-hs       | POST   | /orderservice/order/refresh                  |
| $oo_1$ | order-other    | POST   | /orderOtherService/orderOther/refresh        |
| $ph_1$ | preserve-hs    | POST   | /preserveservice/preserve                    |
| $po_1$ | preserve-other | POST   | /preserveotherservice/preserveOther          |
| $th_1$ | travel-hs      | POST   | /travelservice/trips/left                    |
| $to_1$ | travel-other   | POST   | /travel2service/trips/left                   |
| $tp_1$ | travel-plan    | POST   | /travelplanservice/travelPlan/cheapest       |
| $us_1$ | user           | POST   | /users/login                                 |                                   

## Modeled User Behavior

We modeled three groups of Actors:
- Admin, users who have more privileges and can directly access to CRUD operations for management reasons. 
- Logged, users who need authentication; 
- External users who do not need any authentication;

Both logged and external users are specialized into hs (high speed) and other depending on the kind of trains they 
search or buy (high speed or other, respectively).

<img alt="Actors subdivision" src="./doc/Actors.png" title="Actors subdivision" width="500"/>

Each actor is assigned a selection probability and a likelihood of performing specific behaviors during load injection.
As default, we used: 
- 5% Admin
- 35% Logged
- 60% External

With ratio between high-speed and other of 20% - 80% respectively 

<img alt="Actors percentage" src="./doc/ActorsPercentage.png" title="Actors percentage" width="500"/>

For instance, an external-other actor (a user who is not logged in and is interested in normal trains)
has a 48% probability of being selected, compared to just 5% for an admin actor.
Each actor also has its own probabilities for various operational sequences.
Values have been chosen to simulate a realistic workload based on the type of actor.

|     Actor      | Actor Probability | Sequence  ID |                           Operations Sequence                            | Sequence Probability | Description                      |
|:--------------:|:-----------------:|:------------:|:------------------------------------------------------------------------:|:--------------------:|:---------------------------------|
|  External-hs   |       12\%        |    $b_1$     |                                  $da_3$                                  |        1.71\%        | home                             |
|                |                   |    $b_2$     |                                  $th_1$                                  |        3.43\%        | search travel hs oneway          |
|                |                   |    $b_3$     |                               $th_1, th_1$                               |        3.43\%        | search travel hs roundtrip       |
|                |                   |    $b_4$     |                                  $tp_1$                                  |        3.43\%        | travel plan                      |
|                |                   |              |                                                                          |                      |                                  |
| External-other |       48\%        |    $b_5$     |                                  $da_3$                                  |        6.86\%        | home                             |
|                |                   |    $b_6$     |                                  $to_1$                                  |       13.71\%        | search travel other oneway       |
|                |                   |    $b_7$     |                               $to_1, to_1$                               |       13.71\%        | search travel other roundtrip    |
|                |                   |    $b_8$     |                                  $tp_1$                                  |       13.71\%        | travel plan                      |
|                |                   |              |                                                                          |                      |                                  |
|   Logged-hs    |        7\%        |    $b_9$     |                         $da_3, da_2, us_1, da_3$                         |        0.90\%        | home and login                   |
|                |                   |   $b_{10}$   |                   $th_1, as_1, fo_1, co_1, ph_1, ip_1$                   |        1.80\%        | search and preserve hs oneway    |
|                |                   |   $b_{11}$   | $th_1, as_1, fo_1, co_1, ph_1, ip_1, th_1, as_1, fo_1, co_1, ph_1, ip_1$ |        1.80\%        | search and preserve hs roundtrip |
|                |                   |   $b_{12}$   |                            $oh_1, ca_2, ca_1$                            |        0.36\%        | delete ticket                    |
|                |                   |   $b_{13}$   |                                  $tp_1$                                  |        1.80\%        | travel plan                      |
|                |                   |   $b_{14}$   |                   $oh_1, oo_1, ex_1, oh_1, oo_1, ex_2$                   |        0.36\%        | execute                          |
|                |                   |              |                                                                          |                      |                                  |
|  Logged-other  |       28\%        |   $b_{15}$   |                         $da_3, da_2, us_1, da_3$                         |        3.60\%        | home and login                   |
|                |                   |   $b_{16}$   |                   $to_1, as_1, fo_1, co_1, po_1, ip_1$                   |        7.18\%        | search and preserve hs oneway    |
|                |                   |   $b_{17}$   | $to_1, as_1, fo_1, co_1, po_1, ip_1, to_1, as_1, fo_1, co_1, po_1, ip_1$ |        7.18\%        | search and preserve hs roundtrip |
|                |                   |   $b_{18}$   |                            $oh_1, ca_2, ca_1$                            |        1.43\%        | delete ticket                    |
|                |                   |   $b_{19}$   |                                  $tp_1$                                  |        7.18\%        | travel plan                      |
|                |                   |   $b_{20}$   |                   $oh_1, oo_1, ex_1, oh_1, oo_1, ex_2$                   |        1.43\%        | execute                          |
|                |                   |              |                                                                          |                      |                                  |
|     Admin      |        5\%        |   $b_{21}$   |                         $da_1, us_1, da_1, ao_2$                         |        0.34\%        | home and login                   |
|                |                   |   $b_{22}$   |                            $ar_1, at_2, at_1$                            |        0.67\%        | create travel                    |
|                |                   |   $b_{23}$   |                               $at_2, at_3$                               |        0.67\%        | modify travel                    |
|                |                   |   $b_{24}$   |                                  $ao_3$                                  |        0.67\%        | update order                     |
|                |                   |   $b_{25}$   |                                  $ao_1$                                  |        0.67\%        | create order                     |
|                |                   |   $b_{26}$   |                               $ab_2, ab_4$                               |        0.67\%        | modify price                     |
|                |                   |   $b_{27}$   |                               $ab_1, ab_3$                               |        0.67\%        | modify contact                   |
|                |                   |   $b_{28}$   |                               $au_2, au_1$                               |        0.67\%        | add user                         |

## Configure Test

To setup test configure variables in `config.py` file

| **Category**                   | **Variable**                         | **Description**                                                         | **Default Value**                                                                                                                                                                                                                                     |
|--------------------------------|--------------------------------------|-------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Locust General Config**      | ADD_SPAWNING_SUFFIX                  | Whether to add a suffix to the spawning process.                        | False                                                                                                                                                                                                                                                 |
|                                | LOG_STATISTICS_IN_HALF_MINUTE_CHUNKS | If set to True, logs statistics every 30 seconds.                       | False                                                                                                                                                                                                                                                 |
|                                | PERCENTILES_TO_REPORT                | Percentile values for statistical reporting.                            | [0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.81, 0.82, 0.83, 0.84, 0.85, 0.86, 0.87, 0.88, 0.888, 0.89, 0.90, 0.91, 0.92, 0.93, 0.94, 0.95, 0.96, 0.97, 0.98, 0.99, 0.9973, 0.999, 0.9999, 1.0] |
| **Thinking Time Config**       | TT_AUTOMATIC_MIN                     | Minimum automatic thinking time in seconds.                             | 0.001                                                                                                                                                                                                                                                 |
|                                | TT_AUTOMATIC_MAX                     | Maximum automatic thinking time in seconds.                             | 0.200                                                                                                                                                                                                                                                 |
|                                | TT_USER_MIN                          | Minimum thinking time for user actions in seconds.                      | 1                                                                                                                                                                                                                                                     |
|                                | TT_USER_MAX                          | Maximum thinking time for user actions in seconds.                      | 5                                                                                                                                                                                                                                                     |
| **Connection Config**          | NETWORK_TIMEOUT                      | Maximum network timeout in seconds.                                     | 120.0                                                                                                                                                                                                                                                 |
|                                | CONNECTION_TIMEOUT                   | Maximum connection timeout in seconds.                                  | 120.0                                                                                                                                                                                                                                                 |
| **Actor Distribution Config**  | EXTERNAL_PERCENTAGE                  | Percentage of external actors to be spawned.                            | 60                                                                                                                                                                                                                                                    |
|                                | LOGGED_PERCENTAGE                    | Percentage of logged-in actors to be spawned.                           | 35                                                                                                                                                                                                                                                    |
|                                | ADMIN_PERCENTAGE                     | Percentage of admin actors to be spawned.                               | 5                                                                                                                                                                                                                                                     |
| **Actors Train Choice Config** | HS_PERCENTAGE                        | Percentage of actors choosing HS (High-Speed) trains.                   | 20                                                                                                                                                                                                                                                    |
|                                | OTHER_PERCENTAGE                     | Percentage of actors choosing other train types.                        | 80                                                                                                                                                                                                                                                    |
| **Behavior Config**            | BEHAVIOR_PROBABILITY                 | Probability of choosing another sequence before reset the user session. | 40                                                                                                                                                                                                                                                    |
|                                | RESET_PROBABILITY                    | Probability of resetting user session.                                  | 20                                                                                                                                                                                                                                                    |
| **Logging Config**             | LOG_ALL_REQUESTS                     | Whether to log all requests.                                            | True                                                                                                                                                                                                                                                  |
|                                | LOG_FLUSH_INTERVAL                   | Time interval (in seconds) to flush logs.                               | 5                                                                                                                                                                                                                                                     |
| **Stop on Request Count**      | STOP_ON_REQUEST_COUNT                | Whether to stop the test based on the number of requests.               | True                                                                                                                                                                                                                                                  |
|                                | REQUEST_NUMBER_TO_STOP               | The number of requests after which the test will stop.                  | 20000                                                                                                                                                                                                                                                 |
| **HS Train Types**             | HS_TRAIN_TYPE_ID                     | List of High-Speed train types.                                         | ["GaoTieOne", "DongCheOne"]                                                                                                                                                                                                                           |
| **Other Train Types**          | OTHER_TRAIN_TYPE_ID                  | List of other train types.                                              | ["ZhiDa", "TeKuai", "KuaiSu"]                                                                                                                                                                                                                         |
| **HS Trip List**               | HS_TRIP_LIST                         | List of common HS train trips.                                          | [["nanjing", "zhenjiang", "wuxi", "suzhou", "shanghai"], ["nanjing", "shanghai"], ["nanjing", "suzhou", "shanghai"], ["suzhou", "shanghai"], ["shanghai", "suzhou"]]                                                                                  |
| **Other Trip List**            | OTHER_TRIP_LIST                      | List of common trips on other train types.                              | [["shanghai", "nanjing", "shijiazhuang", "taiyuan"], ["nanjing", "xuzhou", "jinan", "beijing"], ["taiyuan", "shijiazhuang", "nanjing", "shanghai"], ["shanghai", "taiyuan"], ["shanghaihongqiao", "jiaxingnan", "hangzhou"]]                          |
| **Ticket Status**              | TICKET_STATUS_BOOKED                 | Ticket has been booked but not yet paid.                                | 0                                                                                                                                                                                                                                                     |
|                                | TICKET_STATUS_PAID                   | Ticket has been paid.                                                   | 1                                                                                                                                                                                                                                                     |
|                                | TICKET_STATUS_COLLECTED              | Ticket has been collected.                                              | 2                                                                                                                                                                                                                                                     |
|                                | TICKET_STATUS_CANCELLED              | Ticket has been cancelled.                                              | 4                                                                                                                                                                                                                                                     |
|                                | TICKET_STATUS_EXECUTED               | Ticket has been executed (used for travel).                             | 6                                                                                                                                                                                                                                                     |
| **Assurance Types**            | ASSURANCE_TYPES                      | List of assurance types for the ticketing system.                       | ["0", "1"]                                                                                                                                                                                                                                            |

## Run Test
To run the test you need to install Python and Locust. 
Refer to official documentation [here](https://docs.locust.io/en/stable/installation.html).

You can use this command to run load tester in shell. To further customize the test execution refers 
to official [command-line-options](https://docs.locust.io/en/stable/configuration.html#command-line-options) guide.
```shell
locust -H {HOST} -f {LOCUSTFILE_PATH} -u {USERS} -r {SPAWN_RATE} -t {TEST_DURATION} --autostart --autoquit 1 --csv {OUTPUT_FILE_PREFIX}
```


## References

Below is a list of research papers that use this load tester to conduct experiments on microservices architecture.
If you use this workload or a variant of it in a work, consider citing the following scientific papers:

- Colarusso Carmine, Assunta De Caro, Ida Falco, Lorenzo Goglia, and Eugenio Zimeo <br>
  <b> A distributed tracing pipeline for improving locality awareness of microservices applications </b><br>
  Software: Practice and Experience, Volume 54, Number 6 (2024), Pages 1118-1140. https://doi.org/10.1002/spe.3317
  ```bibtex
    @article{colarusso2024distributed,
      title={A distributed tracing pipeline for improving locality awareness of microservices applications},
      author={Colarusso, Carmine and De Caro, Assunta and Falco, Ida and Goglia, Lorenzo and Zimeo, Eugenio},
      journal={Software: Practice and Experience},
      volume={54},
      number={6},
      pages={1118--1140},
      doi={10.1002/spe.3317}
      year={2024},
      publisher={Wiley Online Library}
    }
  ```

- Matteo Camilli, Carmine Colarusso, Barbara Russo, and Eugenio Zimeo <br>
  <b> Actor-Driven Decomposition of Microservices through Multi-level Scalability Assessment </b> <br>
  ACM Transactions on Software Engineering Methodology, Volume 32, Number 5, Article 117 (September 2023), 46
  pages. https://doi.org/10.1145/3583563
  ```bibtex
    @article{10.1145/3583563,
      title = {Actor-Driven Decomposition of Microservices through Multi-level Scalability Assessment},
      author = {Camilli, Matteo and Colarusso, Carmine and Russo, Barbara and Zimeo, Eugenio},
      journal = {ACM Transactions on Software Engineering and Methodology},
      volume = {32},
      number = {5},
      articleno = {117},
      doi = {10.1145/3583563},
      year = {2023},
      publisher = {Association for Computing Machinery}
    }
  ```

- Colarusso Carmine, Ida Falco, and Eugenio Zimeo <br>
  <b> A greedy data-anchored placement of microservices in federated clouds </b><br>
  2024 IEEE International Conference on Cloud Computing Technology and Science (CloudCom), Abu Dhabi, United Arab Emirates, 2024. [TBA]()



